<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>PORTAL DE SERVICIOS</title>
  <!-- Favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1760660050/servicios_uuhqzh.png">
  <meta name="theme-color" content="#007BFF" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- DataTables y Bootstrap -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.4/css/responsive.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.dataTables.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <style>
    body, html {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100%;
      min-height: 100vh;
      background-image: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .container, main.container {
      width: 100vw !important;
      max-width: 100vw !important;
      min-width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.05);
    }
    .titulo-contenedor h1, .titulo-contenedor, h1.titulo-animado {
      font-size: 2rem;
      font-weight: bold;
      color: #007bff;
      text-shadow: 3px 3px 3px #031732;
      animation: rotate 5s infinite linear, stay 10s infinite;
      text-align: center;
    }
    @keyframes rotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
    @keyframes stay { 0%, 25% { transform: rotateY(0deg);} 50%, 75% { transform: rotateY(0deg);} 100% { transform: rotateY(360deg);} }
    .image-container img { max-width: 220px; border-radius: 2px; }
    .copyright { font-size: 0.85em; color: #666; margin-top: 4px; text-align: center; }

    /* ===== LOGIN estilo tipo index2 (reemplaza al diseño anterior) ===== */
    #contactosForm {
      margin: 30px auto 0 auto;
      max-width: 420px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(3px);
      border-radius: 10px;
      border: 2px solid #ddd;
      box-shadow: 0 8px 18px rgba(0,0,0,0.15);
      padding: 16px 16px 10px 16px;
      display: block;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 10;
    }

    #contactosForm label {
      display:block;
      font-weight: 700;
      margin: 10px 0 6px;
      color: #007BFF;
    }

    #contactosForm input[type="number"],
    #contactosForm input[type="password"],
    #contactosForm input[type="text"] {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1.5px solid #888;
      margin-bottom: 7px;
      margin-top: 2px;
      background:#fff;
      outline:none;
      transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }

    #contactosForm input:focus{
      border-color:#007BFF;
    }

    .boton-efecto {
      background: linear-gradient(90deg, #1257b7, #3ea652);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 7px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 1px 2px 4px #ccc;
    }
    .boton-efecto:hover { background: linear-gradient(90deg, #3ea652, #1257b7); }
    .error { color: red; margin-bottom: 8px; text-align: center; font-weight: bold; }
    #tituloProfesional {
      margin: 20px 0 5px 0; font-size: 1.6em; color: #007bff; font-weight: bold; text-align: left; letter-spacing: 1px;
    }
    #tablaServicios th, #tablaServicios td, #tablaServicios thead th, #tablaServicios tfoot th {
      text-align: center !important; vertical-align: middle !important;
    }
    #tablaServicios { width: 100% !important; background: rgba(255,255,255,0.98); border-radius: 10px; margin-top: 20px; }
    .btn-accion { border-radius: 6px !important; font-weight: bold; font-size: 1em; padding: 3px 10px !important; margin-right: 3px; color: #fff !important; }
    .btn-responder { background-color: #e74c3c !important; }
    .btn-editar { background-color: #27ae60 !important; }
    .btn-whatsapp { background: #25D366 !important; color: white !important; border-radius: 6px !important; font-size: 1.15em !important; padding: 3px 10px !important; margin-left: 3px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-whatsapp i { font-size: 1.3em !important; color: white !important; vertical-align: middle; }
    .resaltado-cambio { background: #fff6b2 !important; transition: background 1.6s; }
    .table-responsive { overflow-x: auto; }
    .modal-content { border-radius: 12px; }
    .swal2-popup.swal2-responsive-popup { width: 350px !important; max-width: 95vw; font-size: 15px !important; }
    .icon-btn-header { background: transparent; border: none; cursor: pointer; font-size: 1.5em; vertical-align: middle; color: #1976d2; }
    .icon-btn-header:hover { color: #28a745; }

    .titulo-contenedor { perspective: 1200px; text-align: center; }
    .titulo-animado {
      font-size: 2rem;
      font-weight: bold;
      color: #007BFF;
      text-shadow: 0 2px 2px #031732;
      animation: rotate 5s infinite linear, stay 10s infinite;
    }
    .descripcion-animado { font-size: 1.5rem; font-weight: bold; color: #007BFF; text-shadow: 3px 3px 3px #A9A9A9; animation: rotate 5s infinite linear, stay 10s infinite; }
    .form-description { text-align: center; font-size: 1em; color: #666; margin-bottom: 20px; }
    h1, h2 { text-align: center; margin-bottom: 10px; }

    /* Loader centrado (overlay) */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
      will-change: opacity;
    }
    .loader.hidden{
      display:flex !important;
      opacity:0; pointer-events:none;
    }
    .spinner-ios{
      position:relative; width:64px; height:64px;
    }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{
      0%, 39%, 100% { opacity:.2; }
      40% { opacity:1; }
    }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    /* Input password toggle (login) */
    .input-pass-group { position: relative; width: 100%; }
    .input-pass-group input { width: 100%; padding-right: 42px; }
    .input-pass-group .toggle-pass {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      border: 0; background: transparent; padding: 4px; cursor: pointer; line-height: 0; color: #007bff;
    }
    .input-pass-group .toggle-pass:focus-visible { outline: 2px solid #80bdff; border-radius: 4px; }

    /* Badges de estado */
    .estado-pendiente { color: #c0392b; font-weight: 700; }
    .estado-respondida { color: #27ae60; font-weight: 700; }

    /* Centrar el botón de Iniciar Sesión dentro del formulario */
    #btn-iniciar-sesion {
      display: block;
      width: 100%;
      margin: 12px auto 12px;
    }

    /* Centrar el banner (imagen) dentro del formulario */
    #contactosForm .image-container {
      display: flex;
      justify-content: center;
    }

    #contactosForm .image-container img {
      display: block;
    }

    /* Filtro de Residencia en modal de Registro */
    .residencia-filter-group {
      display: flex; gap: 8px; align-items: center; margin-bottom: 6px;
    }
    .residencia-filter-group input[type="text"] {
      flex: 1 1 auto; padding: 6px 8px; border: 1px solid #888; border-radius: 6px;
    }
    #reg-residencia {
      width: 100%;
    }
</style>
</head>
<body>
  <!-- Loader iOS -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <!-- Formulario de Validación -->
  <form id="contactosForm">
    <div class="titulo-contenedor">
      <h1 class="titulo-animado">PORTAL DE SERVICIOS</h1>
    </div>
    <p style="color: grey; text-align: justify; font-size: 13px;">
      <b>Este Portal es de uso Exclusivo de los Profesionales.</b><br>
      <i>Equipo del Hacer</i>
    </p>

    <label for="documento"><big><b>Documento:</b></big></label>
    <div class="input-pass-group">
      <input
        type="password"
        id="documento"
        name="documento"
        placeholder="Sin puntos ni espacios"
        required
        inputmode="numeric"
        pattern="[0-9]*"
        autocomplete="off"
      />
      <button type="button" id="toggleDocumento" class="toggle-pass" aria-label="Mostrar/Ocultar documento" aria-controls="documento" aria-pressed="false" title="Mostrar/Ocultar">
        <!-- OJO CERRADO (inicial: oculto) -->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
          <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/>
          <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/>
        </svg>
      </button>
    </div>

    <div id="errorMensaje" class="error"></div>
    <button type="button" class="boton-efecto" id="btn-iniciar-sesion" onclick="validarDocumento()"><big><b>Iniciar Sesión</b></big></button>

    <div class="image-container">
      <img id="imagePreview" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="Banner">
    </div>
    <div class="copyright">
      Copyright © <br>
      <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polanía</b></a>
    </div>
  </form>

  <!-- Contenedor de la tabla (oculto al inicio) -->
  <main class="container mt-3" id="mainTableContainer" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:10px; margin-bottom: 0;">
      <div id="tituloProfesional"></div>
      <div style="display: flex; align-items: center;">
        <div class="header-right" style="display:flex; flex-direction:column; align-items:flex-end; margin-right:12px;">
          <div class="image-container" style="margin-bottom:2px; max-width:110px;">
            <img id="imagePreview2" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="Banner" style="max-width:140px;">
          </div>
          <div class="copyright" style="font-size:0.65em;">
            Copyright © <a href="https://wa.me/573103230712" target="_blank"><b>OSCAR POLANIA</b></a>
          </div>
          <button class="boton-efecto" id="btn-cerrar-sesion" onclick="cerrarSesion()" style="background:#C0392B;">Cerrar Sesión</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tablaServicios" class="table table-striped responsive">
        <thead></thead>
        <tbody></tbody>
        <tfoot></tfoot>
      </table>
    </div>
  </main>

  <!-- Modal Responder/Editar -->
  <div class="modal fade" id="modalRespuesta" tabindex="-1" aria-labelledby="modalRespuestaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formRespuesta">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalRespuestaLabel">RESPUESTA A SOLICITUD</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">DOCUMENTO</label>
                <input id="m_doc" class="form-control" type="text" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">NOMBRE</label>
                <input id="m_nombre" class="form-control" type="text" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">CONTACTO</label>
                <input id="m_contacto" class="form-control" type="text" readonly>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">RESIDENCIA</label>
                <input id="m_residencia" class="form-control" type="text" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">SERVICIO</label>
                <input id="m_servicio" class="form-control fw-bold" type="text" readonly>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">RESPONSABLE</label>
                <input id="m_responsable" class="form-control" type="text" placeholder="Responsable">
              </div>
              <div class="col-md-6">
                <label class="form-label">ESTADO</label>
                <input id="m_estado" class="form-control" type="text" readonly>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-12">
                <label class="form-label">SOLICITUD</label>
                <textarea id="m_solicitud" class="form-control" rows="3" readonly></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-12">
                <label class="form-label">RESPUESTA</label>
                <textarea id="m_respuesta" class="form-control" rows="4" placeholder="Escribe la respuesta..."></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label class="form-label">MEDIO</label>
                <input id="m_medio" class="form-control" type="text" readonly>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label class="form-label">AÑO</label>
                <input id="m_ano" class="form-control" type="text" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">MES</label>
                <input id="m_mes" class="form-control" type="text" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">DIA</label>
                <input id="m_dia" class="form-control" type="text" readonly>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardarRespuesta" type="submit" class="boton-efecto">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal WhatsApp -->
  <div class="modal fade" id="modalWhatsapp" tabindex="-1" aria-labelledby="modalWhatsappLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formWhatsapp">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalWhatsappLabel">Enviar WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="mensajeWhatsapp">Mensaje:</label>
            <textarea class="form-control" id="mensajeWhatsapp" rows="6" placeholder="Escribe tu mensaje aquí"></textarea>
          </div>
          <div class="modal-footer">
            <button id="btnEnviarWhatsapp" type="submit" class="boton-efecto" style="background: #25D366;">Enviar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Registro (Agregar) -->
  <div class="modal fade" id="modalRegistro" tabindex="-1" aria-labelledby="modalRegistroLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <!-- IMPORTANTE: desactivar validación nativa para evitar tooltips -->
      <form id="formRegistro" novalidate>
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalRegistroLabel">REGISTRO DE SERVICIO</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-md-4">
               <label class="form-label" for="reg-documento">DOCUMENTO</label>
<div class="pwd-wrapper" style="position:relative; width:100%;">
  <input id="reg-documento" class="form-control" type="text" inputmode="numeric" placeholder="6 a 10 dígitos" required style="padding-right:40px;">
  <button type="button" id="btnBuscarDocumento" aria-label="Buscar documento" class="toggle-cedula" style="
    position:absolute;
    top:50%;
    right:10px;
    transform:translateY(-50%);
    background:transparent !important;
    border:0 !important;
    padding:0;
    width:28px;
    height:28px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border-radius:6px;
  ">
    <img
      src="https://res.cloudinary.com/dqqeavica/image/upload/v1769204556/buscar_vaaua0.webp"
      alt="Buscar"
      style="width:22px;height:22px;display:block;pointer-events:none;border-radius:4px;background:#fff;"
    >
  </button>
</div>
              </div>
              <div class="col-md-8">
                <label class="form-label" for="reg-nombre">NOMBRE</label>
                <input id="reg-nombre" class="form-control" type="text" placeholder="Nombre y Apellido (mínimo 2 palabras)" required>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label" for="reg-contacto">CONTACTO</label>
                <input id="reg-contacto" class="form-control" type="text" inputmode="numeric" placeholder="57XXXXXXXXXX (12 dígitos)" required>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="reg-residencia">RESIDENCIA</label>
                <div class="residencia-filter-group">
                  <input id="reg-residencia-filter" type="text" placeholder="Filtrar residencia..." aria-label="Filtrar residencia">
                </div>
                <select id="reg-residencia" class="form-select" required>
                  <option value="" disabled selected>Selecciona tu Residencia</option>
                  <option value="ACAPULCO I">ACAPULCO I</option>
                  <option value="ACAPULCO II">ACAPULCO II</option>
                  <option value="AGUAMARINA">AGUAMARINA</option>
                  <option value="ALCALA I">ALCALA I</option>
                  <option value="ALFONSO LOPEZ">ALFONSO LOPEZ</option>
                  <option value="ALTAGRACIA I">ALTAGRACIA I</option>
                  <option value="ALTAGRACIA II">ALTAGRACIA II</option>
                  <option value="ALTAGRACIA IV">ALTAGRACIA IV</option>
                  <option value="APROVITEF">APROVITEF</option>
                  <option value="ARAGON I">ARAGON I</option>
                  <option value="ARAGON II">ARAGON II</option>
                  <option value="ARAGON III">ARAGON III</option>
                  <option value="ARAGON IV">ARAGON IV</option>
                  <option value="ARBOLEDA I">ARBOLEDA I</option>
                  <option value="ARBOLEDA II">ARBOLEDA II</option>
                  <option value="BALCONES DE ALEJANDRIA">BALCONES DE ALEJANDRIA</option>
                  <option value="BILBAO">BILBAO</option>
                  <option value="CALA I">CALA I</option>
                  <option value="CANALES">CANALES</option>
                  <option value="CANCUN">CANCUN</option>
                  <option value="CAMALA">CAMALA</option>
                  <option value="CASA DEL SOL I">CASA DEL SOL I</option>
                  <option value="CASA DEL SOL II">CASA DEL SOL II</option>
                  <option value="CENTRO">CENTRO</option>
                  <option value="COLEGIO I">COLEGIO I</option>
                  <option value="COLEGIO II">COLEGIO II</option>
                  <option value="COLEGIO III">COLEGIO III</option>
                  <option value="DUBAI">DUBAI</option>
                  <option value="EL PORTAL DEL RUBI">EL PORTAL DEL RUBI</option>
                  <option value="GAITAN">GAITAN</option>
                  <option value="HANGARES">HANGARES</option>
                  <option value="INVASION BRISAS DEL CARMEN">INVASION BRISAS DEL CARMEN</option>
                  <option value="INVASION VILLA MAGDALENA">INVASION VILLA MAGDALENA</option>
                  <option value="INVASION VILLA MARIANA">INVASION VILLA MARIANA</option>
                  <option value="IQUEIMA">IQUEIMA</option>
                  <option value="JARDINES DE BABILONIA">JARDINES DE BABILONIA</option>
                  <option value="LA CAPILLA">LA CAPILLA</option>
                  <option value="LA CEIBA">LA CEIBA</option>
                  <option value="LA ESPERANZA">LA ESPERANZA</option>
                  <option value="LA PAZ">LA PAZ</option>
                  <option value="LA UNION">LA UNION</option>
                  <option value="LAS ROSAS">LAS ROSAS</option>
                  <option value="LAS VILLAS">LAS VILLAS</option>
                  <option value="LIBERTADOR">LIBERTADOR</option>
                  <option value="LLERAS">LLERAS</option>
                  <option value="LOS MANGOS I">LOS MANGOS I</option>
                  <option value="LOS MANGOS II">LOS MANGOS II</option>
                  <option value="LOS MANGOS III">LOS MANGOS III</option>
                  <option value="LOS MANGOS IV">LOS MANGOS IV</option>
                  <option value="LOS MANGOS V">LOS MANGOS V</option>
                  <option value="LOS MANGOS VI">LOS MANGOS VI</option>
                  <option value="LOS MANGOS VII">LOS MANGOS VII</option>
                  <option value="LOS PIJAOS">LOS PIJAOS</option>
                  <option value="MIRADOR DE LA ESPERANZA">MIRADOR DE LA ESPERANZA</option>
                  <option value="MIRADOR DEL SOL">MIRADOR DEL SOL</option>
                  <option value="MONACO">MONACO</option>
                  <option value="OBRERO">OBRERO</option>
                  <option value="OBRERO DELIRIO">OBRERO DELIRIO</option>
                  <option value="ORQUÍDEAS I">ORQUÍDEAS I</option>
                  <option value="ORQUÍDEAS II">ORQUÍDEAS II</option>
                  <option value="ORQUÍDEAS REAL I">ORQUÍDEAS REAL I</option>
                  <option value="ORQUÍDEAS REAL II">ORQUÍDEAS REAL II</option>
                  <option value="ORQUÍDEAS REAL III">ORQUÍDEAS REAL III</option>
                  <option value="ORQUÍDEAS REAL IV">ORQUÍDEAS REAL IV</option>
                  <option value="PARADERO I">PARADERO I</option>
                  <option value="PARADERO II">PARADERO II</option>
                  <option value="PARAISO">PARAISO</option>
                  <option value="PAKISTAN I">PAKISTAN I</option>
                  <option value="PAKISTAN II">PAKISTAN II</option>
                  <option value="PAKISTAN III">PAKISTAN III</option>
                  <option value="PALO VERDE">PALO VERDE</option>
                  <option value="PARQUES DE ALEJANDRIA I">PARQUES DE ALEJANDRIA I</option>
                  <option value="PARQUES DE ALEJANDRIA II">PARQUES DE ALEJANDRIA II</option>
                  <option value="PARQUES DE ALEJANDRIA III">PARQUES DE ALEJANDRIA III</option>
                  <option value="PARQUES DE ALEJANDRIA IV">PARQUES DE ALEJANDRIA IV</option>
                  <option value="PARQUES DE PAKISTAN I">PARQUES DE PAKISTAN I</option>
                  <option value="PARQUES DE PAKISTAN II">PARQUES DE PAKISTAN II</option>
                  <option value="PARQUES DE PAKISTAN III">PARQUES DE PAKISTAN III</option>
                  <option value="PARQUES DE PAKISTAN IV">PARQUES DE PAKISTAN IV</option>
                  <option value="PARQUES DE PAKISTAN V">PARQUES DE PAKISTAN V</option>
                  <option value="PORTAL DEL RUBY">PORTAL DEL RUBY</option>
                  <option value="PRADERAS DE PALMA REAL">PRADERAS DE PALMA REAL</option>
                  <option value="PRADOS DE SAN REMO">PRADOS DE SAN REMO</option>
                  <option value="PUERTA BLANCA">PUERTA BLANCA</option>
                  <option value="PUERTO BAHIA I">PUERTO BAHIA I</option>
                  <option value="PUERTO BAHIA II">PUERTO BAHIA II</option>
                  <option value="PUERTO DOMINGO">PUERTO DOMINGO</option>
                  <option value="PUERTO MEDITERRANEO">PUERTO MEDITERRANEO</option>
                  <option value="QUINTAS DE SAN ESTEBAN">QUINTAS DE SAN ESTEBAN</option>
                  <option value="QUINTAS DE SAN FRANCISCO">QUINTAS DE SAN FRANCISCO</option>
                  <option value="QUINTAS DEL DIVINO NIÑO">QUINTAS DEL DIVINO NIÑO</option>
                  <option value="QUINTAS FERROVIARIAS">QUINTAS FERROVIARIAS</option>
                  <option value="RIVERAS DEL MAGDALENA">RIVERAS DEL MAGDALENA</option>
                  <option value="SAN ANDRES">SAN ANDRES</option>
                  <option value="SAN FELIPE DE BARAJAS">SAN FELIPE DE BARAJAS</option>
                  <option value="SAN FEMANDO DE SEGOVIA">SAN FEMANDO DE SEGOVIA</option>
                  <option value="SAN FRANCISCO">SAN FRANCISCO</option>
                  <option value="SAN LUIS">SAN LUIS</option>
                  <option value="SANTA ANA">SANTA ANA</option>
                  <option value="SANTA HAGIA SOTA">SANTA HAGIA SOTA</option>
                  <option value="SANTA MARTHA">SANTA MARTHA</option>
                  <option value="SANTA MONICA I">SANTA MONICA I</option>
                  <option value="SANTA MONICA II">SANTA MONICA II</option>
                  <option value="SINAI">SINAI</option>
                  <option value="SOL Y BRISA">SOL Y BRISA</option>
                  <option value="TARQUI">TARQUI</option>
                  <option value="TAYRONA">TAYRONA</option>
                  <option value="TERRAZAS DE ALEJANDRIA">TERRAZAS DE ALEJANDRIA</option>
                  <option value="TOPACIO">TOPACIO</option>
                  <option value="TRIANA">TRIANA</option>
                  <option value="URBANIZACION ARRAYANES">URBANIZACION ARRAYANES</option>
                  <option value="URBANIZACION EL PALMAR">URBANIZACION EL PALMAR</option>
                  <option value="URBANIZACION EL PORTAL">URBANIZACION EL PORTAL</option>
                  <option value="URBANIZACION EL RUBY">URBANIZACION EL RUBY</option>
                  <option value="URBANIZACION LOS ALMENDROS">URBANIZACION LOS ALMENDROS</option>
                  <option value="URBANIZACION VILLA LUCIA">URBANIZACION VILLA LUCIA</option>
                  <option value="URBANIZACION VILLA MAGDALENA I">URBANIZACION VILLA MAGDALENA I</option>
                  <option value="URBANIZACION VILLA MAGDALENA II">URBANIZACION VILLA MAGDALENA II</option>
                  <option value="URBANIZACION VILLA MAGDALENA III">URBANIZACION VILLA MAGDALENA III</option>
                  <option value="URBANIZACION VILLA MARIANA">URBANIZACIÓN VILLA MARIANA</option>
                  <option value="VALLESUE">VALLESUE</option>
                  <option value="VENECIA I">VENECIA I</option>
                  <option value="VENECIA II">VENECIA II</option>
                  <option value="VENECIA III">VENECIA III</option>
                  <option value="VENECIA IV">VENECIA IV</option>
                  <option value="VILLA DE LAS PALMAS">VILLA DE LAS PALMAS</option>
                  <option value="VILLA DEL RIO I">VILLA DEL RIO I</option>
                  <option value="VILLA DEL RIO II">VILLA DEL RIO II</option>
                  <option value="VILLA DEL SOL">VILLA DEL SOL</option>
                  <option value="VILLA ESPERANZA">VILLA ESPERANZA</option>
                  <option value="VILLA LAS PALMAS">VILLA LAS PALMAS</option>
                  <option value="VILLA MEDINA">VILLA MEDINA</option>
                  <option value="VILLAS DEL MEDITERANEO">VILLAS DEL MEDITERANEO</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label" for="reg-servicio">SERVICIO</label>
                <input id="reg-servicio" class="form-control fw-bold" type="text" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="reg-profesional">PROFESIONAL</label>
                <input id="reg-profesional" class="form-control" type="text" readonly>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-12">
                <label class="form-label" for="reg-solicitud">SOLICITUD</label>
                <textarea id="reg-solicitud" class="form-control" rows="3" placeholder="Describe la solicitud..." required></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-12">
                <label class="form-label" for="reg-respuesta">RESPUESTA</label>
                <textarea id="reg-respuesta" class="form-control" rows="4" placeholder="Escribe la respuesta..." required></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardarRegistro" type="submit" class="boton-efecto">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- JS y dependencias -->
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>

  <!-- FIX: Cargar los nombres CORRECTOS de Responsive para DataTables -->
  <script src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"></script>

  <script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    // URL del Web App (ACTUALIZA este valor al desplegar el proyecto GS de PORTAL DE SERVICIOS)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjJX1uAE00cvX2mhhn3-W9_kIDaPTCeF09LmQIGk3izfQ-S2qMJO4lRAoQ5PaMq63R9A/exec';

    // Sonidos
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{ const a = new Audio(url); a.preload = 'auto'; a.play().catch(()=>{}); }catch(e){}
    }
    // Parche SweetAlert2 para sonidos
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    // Loader
    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
        loader.classList.add('hidden');
      }
    }

    // Adaptadores API
    async function apiValidarProfesional(documento) {
      startLoading();
      try{
        const url = new URL(WEB_APP_URL);
        url.searchParams.set('action', 'validarProfesional');
        url.searchParams.set('documento', documento);
        const resp = await fetch(url.toString(), { method: 'GET' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    async function apiGuardarRespuesta({ rowIndex, responsable, respuesta }) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'guardarRespuesta',
          rowIndex: String(rowIndex || ''),
          responsable: responsable || '',
          respuesta: respuesta || ''
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    async function apiEliminarFilasServicios({ documento, rowIndices }) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'eliminarFilasServicios',
          documento: documento || '',
          rowIndices: JSON.stringify(rowIndices || [])
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    // NUEVO: Guardar Solicitud (Agregar)
   async function apiBuscarEnPrincipal(documento) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'buscarEnPrincipal',
          documento: documento || ''
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    async function buscarYAutocompletarRegistro() {
      const docInput = document.getElementById('reg-documento');
      const nombreInput = document.getElementById('reg-nombre');
      const telInput = document.getElementById('reg-contacto');
      const selResidencia = document.getElementById('reg-residencia');
      const filtroResidencia = document.getElementById('reg-residencia-filter');

      const documento = String(docInput?.value || '').trim().replace(/\D/g,'');
      if (!/^\d{6,10}$/.test(documento)) {
        Swal.fire({
          icon:'warning',
          title:'Documento inválido',
          text:'Ingresa de 6 a 10 dígitos para buscar.',
          customClass:{ popup:'swal2-responsive-popup' }
        });
        return;
      }

      try {
        const res = await apiBuscarEnPrincipal(documento);

        if (!res || res.ok !== true || !res.encontrado) {
          Swal.fire({
            icon:'info',
            title:'No encontrado',
            text:'No encontramos este documento en PRINCIPAL. Puedes continuar el registro.',
            timer: 2200,
            showConfirmButton:false,
            customClass:{ popup:'swal2-responsive-popup' }
          });
          return;
        }

        const data = res.data || {};

        if (data.nombre && nombreInput) {
          nombreInput.value = String(data.nombre || '').trim();
        }

        if (data.contacto && telInput) {
          let contacto = String(data.contacto || '').replace(/\D/g,'');
          if (!contacto.startsWith('57')) contacto = '57' + contacto;
          telInput.value = contacto;
        }

        if (data.residencia && selResidencia) {
  const residenciaRaw = String(data.residencia || '').trim();

  // Mostrar todas las opciones (por si el filtro las ocultó)
  Array.from(selResidencia.options).forEach((opt, idx) => {
    if (idx > 0) opt.hidden = false;
  });
  if (filtroResidencia) filtroResidencia.value = '';

  // Normalizador (quita tildes y compara en MAYÚSCULAS)
  const norm = (s) => String(s || '')
    .trim()
    .toUpperCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');

  const target = norm(residenciaRaw);

  // 1) intento directo
  selResidencia.value = residenciaRaw;

  // 2) si no quedó seleccionado, buscar por comparación normalizada
  if (!selResidencia.value) {
    const options = Array.from(selResidencia.options);
    const match = options.find((opt, idx) => {
      if (idx === 0) return false; // placeholder
      return norm(opt.value) === target || norm(opt.textContent) === target;
    });
    if (match) selResidencia.value = match.value;
  }

  // Si aún no se pudo, no frenamos el flujo (queda editable)
}

        playSoundOnce(SOUNDS.success);
        Swal.fire({
          icon:'success',
          title:'Datos encontrados',
          text:'Se autocompletó desde PRINCIPAL. Puedes editar los campos si lo deseas.',
          timer: 2000,
          showConfirmButton:false,
          customClass:{ popup:'swal2-responsive-popup' }
        });
      } catch (err) {
        Swal.fire({
          icon:'error',
          title:'Error al buscar',
          text:String(err),
          customClass:{ popup:'swal2-responsive-popup' }
        });
      }
    }

    // NUEVO: Guardar Solicitud (Agregar)
    async function apiGuardarSolicitud(formData) {
      startLoading();
      try {
        const body = new URLSearchParams({
          action: 'guardarSolicitud',
          documento: formData.documento || '',
          nombre: formData.nombre || '',
          telefono: formData.telefono || '',
          residencia: formData.residencia || '',
          servicio: formData.servicio || '',
          responsable: formData.responsable || '',
          solicitud: formData.solicitud || '',
          respuesta: formData.respuesta || ''
        });
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      } finally { stopLoading(); }
    }

    // Estado global
    let esAdmin = false;
    let nombreProfesional = '';
    let servicioProfesional = '';
    let encabezados = [];
    let filas = [];
    let tabla;
    let documentoGuardado = '';
    let deleteMode = false;
    let selectedRowIndices = new Set(); // __ROW__ de SERVICIOS

    // Login y pantalla
    async function validarDocumento() {
      const input = document.getElementById('documento');
      const documento = (input.value || '').trim();

      if (documento === "") {
        Swal.fire({ icon: 'warning', title: 'Campo requerido', text: 'Ingresa un documento para validar.', customClass: { popup: 'swal2-responsive-popup' } });
        return;
      }
      if (!/^\d{6,10}$/.test(documento)) {
        Swal.fire({ icon: 'warning', title: 'Formato incorrecto', text: 'Ingresa un N° de Documento correcto (6 a 10 dígitos).', customClass: { popup: 'swal2-responsive-popup' } });
        return;
      }
      if (navigator.clipboard) { navigator.clipboard.writeText(documento).catch(()=>{}); }

      playSoundOnce(SOUNDS.login);
      Swal.fire({
        title: 'Validando...',
        html: 'Por favor espera unos segundos.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => { Swal.showLoading(); }
      });

      try {
        const res = await apiValidarProfesional(documento);
        Swal.close();

        if (!res || res.existe !== true) {
          Swal.fire({
            icon: 'error',
            title: 'Acceso restringido',
            html: 'Este Portal es de uso exclusivo de los Profesionales del Equipo del Hacer.<br><br><div class="copyright">Copyright © <a href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank"><b>BOT HEART</b></a></div>',
            width: '90%', padding: '1rem', customClass: { popup: 'swal2-responsive-popup' }
          });
          mostrarFormulario();
          return;
        }

        esAdmin = !!res.esAdmin;
        nombreProfesional = res.nombreProfesional || '';
        servicioProfesional = res.servicioProfesional || '';
        encabezados = res.encabezados || [];
        filas = res.filas || [];
        documentoGuardado = documento;

        document.getElementById('tituloProfesional').textContent =
          'Profesional ' + (nombreProfesional || (esAdmin ? 'ADMINISTRADOR' : ''));

               if (!filas || filas.length === 0) {
          const r = await Swal.fire({
            icon: 'info',
            title: 'Sin registros',
            text: 'No hay solicitudes para tu servicio en este momento, puedes crear tu primer servicio.',
            showCancelButton: true,
            confirmButtonText: 'CREAR',
            cancelButtonText: 'Volver',
            width: '90%',
            padding: '1rem',
            customClass: { popup: 'swal2-responsive-popup' }
          });

          if (r.isConfirmed) {
            // Entrar al módulo y abrir directamente el modal Agregar
            ocultarFormulario();

            // Asegurar que exista tabla aunque esté vacía (para que luego refresque sin problemas)
            if (tabla) { tabla.destroy(); }
            inicializarTabla();

            // Abrir modal Agregar
            abrirModalRegistro();
            return;
          }

          mostrarFormulario();
          return;
        }

        ocultarFormulario();
        inicializarTabla();
      } catch (err) {
        Swal.close();
        Swal.fire({ icon:'error', title:'Error de red', text:String(err) });
      }
    }

    function mostrarFormulario() {
      document.getElementById('contactosForm').style.display = 'block';
      document.getElementById('mainTableContainer').style.display = 'none';
      document.getElementById('tituloProfesional').textContent = "";
    }
    function ocultarFormulario() {
      document.getElementById('contactosForm').style.display = 'none';
      document.getElementById('mainTableContainer').style.display = 'block';
    }
    function cerrarSesion() {
      playSoundOnce(SOUNDS.logout);
      esAdmin = false;
      nombreProfesional = '';
      servicioProfesional = '';
      encabezados = [];
      filas = [];
      documentoGuardado = '';
      selectedRowIndices.clear();
      deleteMode = false;
      if (tabla) { tabla.destroy(); }
      mostrarFormulario();
      document.getElementById('documento').value = "";
    }

    function centrarEncabezadosTabla() {
      $('#tablaServicios thead th, #tablaServicios tfoot th')
        .removeClass('text-start text-left text-end text-right')
        .addClass('text-center')
        .css('text-align', 'center');
    }

    function inicializarTabla() {
      // Construir columnas base desde encabezados (incluye "__ROW__" al final)
      const idxDocumento   = encabezados.indexOf('DOCUMENTO');
      const idxNombre      = encabezados.indexOf('NOMBRE');
      const idxContacto    = encabezados.indexOf('CONTACTO');
      const idxResidencia  = encabezados.indexOf('RESIDENCIA');
      const idxServicio    = encabezados.indexOf('SERVICIO');
      const idxResponsable = encabezados.indexOf('RESPONSABLE');
      const idxSolicitud   = encabezados.indexOf('SOLICITUD');
      const idxEstado      = encabezados.indexOf('ESTADO');
      const idxRespuesta   = encabezados.indexOf('RESPUESTA');
      const idxAno         = encabezados.indexOf('AÑO');
      const idxMes         = encabezados.indexOf('MES');
      const idxDia         = encabezados.indexOf('DIA');
      const idxRowIndex    = encabezados.indexOf('__ROW__');

      // Columnas visibles + Acciones + Selección (admin) + __ROW__ (oculta)
      let colsDT = encabezados.slice(0, encabezados.length - 1).map((h) => ({ title: h })); // sin __ROW__
      colsDT.push({ title: "Acción" });   // RESPONDER/EDITAR
      colsDT.push({ title: "WhatsApp" }); // WHATSAPP
      colsDT.push({ title: "Seleccionar" }); // Admin
      colsDT.push({ title: "__ROW__" }); // Índice real de hoja (oculta)

      // Construir HTML de thead/tfoot
      $("#tablaServicios thead").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");
      $("#tablaServicios tfoot").html("<tr>"+colsDT.map(col=>`<th class='text-center'>${col.title}</th>`).join("")+"</tr>");

      // Data: agregar columnas de acción, selección y __ROW__
            const data = (Array.isArray(filas) ? filas : []).map(row => {
        const base = row.slice(0, encabezados.length - 1); // A..L
        const rowIndexVal = row[idxRowIndex]; // __ROW__
        return [...base, '', '', '', rowIndexVal];
      });

      if ($.fn.DataTable.isDataTable('#tablaServicios')) {
        $('#tablaServicios').DataTable().destroy();
        $('#tablaServicios').empty();
      }

      // Índices calculados en tabla final
      const idxAccion     = colsDT.length - 4;
      const idxWhatsapp   = colsDT.length - 3;
      const idxSeleccion  = colsDT.length - 2;
      const idxRowHidden  = colsDT.length - 1;

      // Columnas a ocultar inicialmente
      const toHideHeaders = ['DOCUMENTO', 'CONTACTO', 'AÑO', 'MES', 'DIA', '__ROW__'];
      const ocultarIdxs = colsDT.map((c, i) => i).filter(i => toHideHeaders.includes(colsDT[i].title));

      // Botones por rol
      const colvisButton = { extend: 'colvis', text: 'Filtrar Columnas' };
      const btnAgregar = {
        text: `Agregar <span class="ms-1 align-middle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-plus-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M8.5 7v1.5H10a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V9.5H6a.5.5 0 0 1 0-1h1.5V7a.5.5 0 0 1 1 0"/>
          </svg>
        </span>`,
        className: 'btn btn-primary',
        attr: { id: 'btnAgregar' },
        action: function(e, dt) {
          abrirModalRegistro();
        }
      };
      const commonExportButtons = [
        btnAgregar,
        { extend: 'copy',  text: '<i class="bi bi-clipboard-fill"></i>', className: 'btn btn-secondary', exportOptions: { columns: ':visible' }, title: 'Servicios ' + nombreProfesional },
        { extend: 'excel', text: '<i class="bi bi-file-earmark-excel-fill"></i>', className: 'btn btn-success',  exportOptions: { columns: ':visible' }, filename: 'Servicios ' + nombreProfesional, title: 'Servicios ' + nombreProfesional },
        { extend: 'pdf',   text: '<i class="bi bi-file-earmark-pdf-fill"></i>',   className: 'btn btn-danger',   exportOptions: { columns: ':visible' }, filename: 'Servicios ' + nombreProfesional, title: 'Servicios ' + nombreProfesional },
        { extend: 'print', text: '<i class="bi bi-printer-fill"></i>',            className: 'btn btn-info',     exportOptions: { columns: ':visible' }, title: 'Servicios ' + nombreProfesional },
        colvisButton
      ];

      const btnEliminar = {
        text: `Eliminar <span class="ms-1 align-middle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-minus-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M6 8.5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1 0-1"/>
          </svg>
        </span>`,
        className: 'btn btn-outline-danger',
        attr: { id: 'btnEliminarFilas' },
        action: function(e, dt) {
          playSoundOnce(SOUNDS.warning);
          deleteMode = true;
          selectedRowIndices.clear();
          dt.column(idxSeleccion).visible(true);
          $('#btnEliminarFilas').addClass('d-none');
          $('#btnConfirmarEliminacion, #btnDescartarEliminacion').removeClass('d-none');
          Swal.fire({
            icon: 'warning',
            title: 'Modo eliminación',
            text: 'Selecciona una o varias filas para eliminar.',
            timer: 1800,
            showConfirmButton: false,
            customClass: { popup: 'swal2-responsive-popup' }
          });
        }
      };

      const btnConfirmar = {
        text: `Confirmar <span class="ms-1 align-middle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
          </svg>
        </span>`,
        className: 'btn btn-danger d-none',
        attr: { id: 'btnConfirmarEliminacion' },
        action: async function(e, dt) {
          if (selectedRowIndices.size === 0) {
            Swal.fire({ icon: 'info', title: 'Sin selección', text: 'Selecciona al menos una fila.', customClass: { popup: 'swal2-responsive-popup' } });
            return;
          }
          const toDelete = Array.from(selectedRowIndices);

          try {
            Swal.fire({ title: 'Eliminando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const res = await apiEliminarFilasServicios({ documento: documentoGuardado, rowIndices: toDelete });
            Swal.close();
            if (!res || res.ok !== true) { throw new Error(res && res.error ? res.error : 'No se pudo eliminar'); }

            // Quitar filas localmente
            dt.rows(function(idx, rowData) {
              const rowIndexVal = String(rowData[idxRowHidden] || '');
              return toDelete.includes(rowIndexVal);
            }).remove().draw(false);

            // Salir del modo eliminación
            exitDeleteMode(dt);

            playSoundOnce(SOUNDS.success);
            Swal.fire({
              icon: 'success',
              title: 'Fila(s) eliminada(s)',
              html: (res.eliminadas || 0) + ' fila(s) eliminada(s).',
              timer: 3000,
              showConfirmButton: false,
              customClass: { popup: 'swal2-responsive-popup' }
            });
          } catch (err) {
            Swal.fire({ icon: 'error', title: 'Error al eliminar', text: String(err), customClass: { popup: 'swal2-responsive-popup' } });
          }
        }
      };

      const btnDescartar = {
        text: `Descartar <span class="ms-1 align-middle">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
            <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708"/>
          </svg>
        </span>`,
        className: 'btn btn-secondary d-none',
        attr: { id: 'btnDescartarEliminacion' },
        action: function(e, dt) {
          playSoundOnce(SOUNDS.back);
          exitDeleteMode(dt);
        }
      };

      const buttonsArr = esAdmin ? [...commonExportButtons, btnEliminar, btnConfirmar, btnDescartar] : [...commonExportButtons];

      // Inicializar DataTable
      tabla = $('#tablaServicios').DataTable({
        language: { url: "//cdn.datatables.net/plug-ins/2.3.2/i18n/es-CO.json" },
        responsive: false,
        dom: 'Blfrtip',
        scrollX: true,
        autoWidth: true,
        pagingType: 'full_numbers',
        lengthMenu: [5, 10, 20, 50, 100],
        columns: colsDT,
        data: data,
        order: [[idxRowHidden, 'desc']], // Descendente por índice real de hoja
        buttons: buttonsArr,
        columnDefs: [
          // Ocultar columnas iniciales
          ...ocultarIdxs.map(idx => ({ targets: idx, visible: false })),
          // SERVICIO en negrilla
          {
            targets: idxServicio,
            createdCell: function(td) { td.style.fontWeight = '700'; }
          },
          // ESTADO con color
          {
            targets: idxEstado,
            render: function(val) {
              const v = String(val || '').trim().toUpperCase();
              if (v === 'RESPONDIDA') return `<span class="estado-respondida">RESPONDIDA</span>`;
              return `<span class="estado-pendiente">PENDIENTE</span>`;
            }
          },
          // Acción RESPONDER/EDITAR
          {
            targets: idxAccion,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const estadoVal = String(row[idxEstado] || '').trim().toUpperCase();
              const isRespondida = (estadoVal === 'RESPONDIDA');
              const btnText = isRespondida ? 'EDITAR' : 'RESPONDER';
              const btnClass = isRespondida ? 'btn-editar' : 'btn-responder';
              return `<button class="btn-accion ${btnClass}" data-row="${meta.row}" onclick="abrirModalRespuesta(${meta.row})">${btnText}</button>`;
            }
          },
          // WhatsApp
          {
            targets: idxWhatsapp,
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              return `<button class="btn-whatsapp" data-row="${meta.row}" onclick="abrirModalWhatsapp(${meta.row})"><i class="bi bi-whatsapp"></i></button>`;
            }
          },
          // Selección (admin)
          {
            targets: idxSeleccion,
            orderable: false,
            searchable: false,
            visible: esAdmin ? false : false,
            className: 'text-center',
            render: function(data, type, row, meta) {
              const rowIndexVal = String(row[idxRowHidden] || '');
              const checked = selectedRowIndices.has(rowIndexVal) ? 'checked' : '';
              return `<input type="checkbox" class="form-check-input row-select" data-rowindex="${rowIndexVal}" ${checked} />`;
            }
          },
          // __ROW__ oculto
          {
            targets: idxRowHidden,
            visible: false,
            searchable: false
          }
        ]
      });

      tabla.off('draw');
      tabla.on('draw', centrarEncabezadosTabla);
      centrarEncabezadosTabla();

      // Delegación para checkboxes (admin)
      $('#tablaServicios tbody').off('change', 'input.row-select');
      $('#tablaServicios tbody').on('change', 'input.row-select', function() {
        const rowIndexVal = String(this.dataset.rowindex || '');
        if (!rowIndexVal) return;
        if (this.checked) selectedRowIndices.add(rowIndexVal);
        else selectedRowIndices.delete(rowIndexVal);
      });

      function exitDeleteMode(dt) {
        deleteMode = false;
        selectedRowIndices.clear();
        dt.column(idxSeleccion).visible(false);
        $('#btnConfirmarEliminacion, #btnDescartarEliminacion').addClass('d-none');
        $('#btnEliminarFilas').removeClass('d-none');
      }
    }

    // ---- Modal Responder / Editar ----
    let filaEdicion = null;
    function abrirModalRespuesta(idxFila) {
      filaEdicion = idxFila;
      const row = tabla.row(idxFila).data();

      // Mapeo de columnas usando encabezados actuales
      const idxDocumento   = encabezados.indexOf('DOCUMENTO');
      const idxNombre      = encabezados.indexOf('NOMBRE');
      const idxContacto    = encabezados.indexOf('CONTACTO');
      const idxResidencia  = encabezados.indexOf('RESIDENCIA');
      const idxServicio    = encabezados.indexOf('SERVICIO');
      const idxResponsable = encabezados.indexOf('RESPONSABLE');
      const idxSolicitud   = encabezados.indexOf('SOLICITUD');
      const idxEstado      = encabezados.indexOf('ESTADO');
      const idxRespuesta   = encabezados.indexOf('RESPUESTA');
      const idxMedio       = encabezados.indexOf('MEDIO');
      const idxAno         = encabezados.indexOf('AÑO');
      const idxMes         = encabezados.indexOf('MES');
      const idxDia         = encabezados.indexOf('DIA');

      document.getElementById('m_doc').value        = row[idxDocumento] || '';
      document.getElementById('m_nombre').value     = row[idxNombre] || '';
      document.getElementById('m_contacto').value   = row[idxContacto] || '';
      document.getElementById('m_residencia').value = row[idxResidencia] || '';
      document.getElementById('m_servicio').value   = row[idxServicio] || '';
      document.getElementById('m_responsable').value = (row[idxResponsable] || nombreProfesional || '');
            const inpResp = document.getElementById('m_responsable');
      if (inpResp) {
        inpResp.value = (nombreProfesional || '').toString();
        inpResp.readOnly = true;
        inpResp.title = 'Este campo no se puede editar';
      }
      document.getElementById('m_estado').value     = (String(row[idxEstado] || '').trim().toUpperCase() || 'PENDIENTE');
      document.getElementById('m_solicitud').value  = row[idxSolicitud] || '';
      document.getElementById('m_respuesta').value  = row[idxRespuesta] || '';
      document.getElementById('m_medio').value      = row[idxMedio] || '';
      document.getElementById('m_ano').value        = row[idxAno] || '';
      document.getElementById('m_mes').value        = row[idxMes] || '';
      document.getElementById('m_dia').value        = row[idxDia] || '';

      const estadoVal = String(row[idxEstado] || '').trim().toUpperCase();
      const isRespondida = (estadoVal === 'RESPONDIDA');
      const btn = document.getElementById('btnGuardarRespuesta');
      btn.textContent = isRespondida ? 'Actualizar' : 'Guardar';

      new bootstrap.Modal(document.getElementById('modalRespuesta')).show();
    }

    document.getElementById('formRespuesta').addEventListener('submit', async function(e){
      e.preventDefault();
      if (filaEdicion == null) return;

      // Índices
      const idxResponsable = encabezados.indexOf('RESPONSABLE');
      const idxEstado      = encabezados.indexOf('ESTADO');
      const idxRespuesta   = encabezados.indexOf('RESPUESTA');

      const rowData = tabla.row(filaEdicion).data();
      const rowIndex = rowData[rowData.length - 1]; // __ROW__ oculto
      const responsable = (nombreProfesional || '').toString().trim();
      const respuesta = document.getElementById('m_respuesta').value.trim();

      if (!responsable || !respuesta) {
        Swal.fire({ icon:'warning', title:'Campos requeridos', text:'RESPONSABLE y RESPUESTA son obligatorios.', customClass: { popup: 'swal2-responsive-popup' } });
        return;
      }

      try {
        const res = await apiGuardarRespuesta({ rowIndex, responsable, respuesta });
        if (!res || res.ok !== true) throw new Error(res && res.error ? res.error : 'No se pudo guardar');

        // Actualizar localmente
        const nueva = rowData.slice();
        nueva[idxResponsable] = responsable;
        nueva[idxRespuesta] = respuesta;
        nueva[idxEstado] = 'RESPONDIDA';

        tabla.row(filaEdicion).data(nueva).invalidate().draw(false);

        // Resaltar cambios en columnas clave
        const tr = tabla.row(filaEdicion).node();
        [idxResponsable, idxRespuesta, idxEstado].forEach(i => {
          if (tr && tr.children[i]) {
            tr.children[i].classList.add('resaltado-cambio');
            setTimeout(()=>{ tr.children[i].classList.remove('resaltado-cambio'); }, 2000);
          }
        });

        bootstrap.Modal.getInstance(document.getElementById('modalRespuesta')).hide();
        Swal.fire({
          icon: 'success',
          title: '¡Datos actualizados!',
          html: 'La respuesta fue guardada correctamente.',
          timer: 2500,
          showConfirmButton: false
        });
      } catch (err) {
        Swal.fire({ icon:'error', title:'Error al guardar', text:String(err) });
      }
    });

    // ---- WhatsApp ----
    let filaWhatsapp = null;
    function abrirModalWhatsapp(idxFila) {
      filaWhatsapp = idxFila;
      const row = tabla.row(idxFila).data();

      const idxNombre    = encabezados.indexOf('NOMBRE');
      const idxContacto  = encabezados.indexOf('CONTACTO');
      const idxSolicitud = encabezados.indexOf('SOLICITUD');
      const idxRespuesta = encabezados.indexOf('RESPUESTA');
      const idxResp      = encabezados.indexOf('RESPONSABLE');

      const nombre = row[idxNombre] || '';
      const solicitud = row[idxSolicitud] || '';
      const respuesta = row[idxRespuesta] || '';
      const responsable = (row[idxResp] || nombreProfesional || '').toString();

      const mensajeBase =
        `Hola ${nombre} buen día 👋🏻
Hemos revisado atentamente tu solicitud:
${solicitud}
Te respondemos los siguiente:
${respuesta}

Cordialmente,

${responsable}
> Equipo del Hacer`;

      const ta = document.getElementById('mensajeWhatsapp');
      ta.value = mensajeBase;

      new bootstrap.Modal(document.getElementById('modalWhatsapp')).show();
    }

    document.getElementById('formWhatsapp').addEventListener('submit', function(e){
      e.preventDefault();
      const mensaje = document.getElementById('mensajeWhatsapp').value.trim();
      const rowData = tabla.row(filaWhatsapp).data();

      const idxContacto  = encabezados.indexOf('CONTACTO');
      let numero = (rowData[idxContacto] || '').toString().replace(/\D/g, '');

      if (!numero) {
        Swal.fire({icon:'error',title:'No hay número de WhatsApp disponible en la fila'});
        return;
      }

      if (navigator.clipboard && mensaje) { navigator.clipboard.writeText(mensaje).catch(()=>{}); }
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const whatsappUrl = isMobile
        ? ('whatsapp://send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje))
        : ('https://api.whatsapp.com/send?phone=' + encodeURIComponent(numero) + '&text=' + encodeURIComponent(mensaje));
      window.open(whatsappUrl, "_blank");

      bootstrap.Modal.getInstance(document.getElementById('modalWhatsapp')).hide();
    });

    // Botones sonido
    document.getElementById('btn-iniciar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.login));
    document.getElementById('btn-cerrar-sesion')?.addEventListener('click', ()=> playSoundOnce(SOUNDS.logout));

    // Mostrar/Ocultar documento
    (function(){
      const input = document.getElementById('documento');
      const btn = document.getElementById('toggleDocumento');

      const ICON_EYE_SLASH = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
  <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7 7 0 0 0 2.79-.588M5.21 3.088A7 7 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/>
  <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/>
</svg>`;
      const ICON_EYE = `
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
  <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
  <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
</svg>`;

      if (input && btn){
        btn.addEventListener('click', function(){
          const willShow = input.type === 'password';
          input.type = willShow ? 'text' : 'password';
          btn.setAttribute('aria-pressed', String(willShow));
          btn.innerHTML = willShow ? ICON_EYE : ICON_EYE_SLASH;
          try {
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
          } catch(e){}
        });
      }
    })();

    // ---------- NUEVO: Modal Registro (Agregar) ----------
    let modalRegistroInstance = null;
    function abrirModalRegistro(){
      if (!documentoGuardado) {
        Swal.fire({ icon:'warning', title:'Sesión requerida', text:'Debes iniciar sesión para agregar un servicio.', customClass: { popup: 'swal2-responsive-popup' }});
        return;
      }
      // Prefill
      const inpDoc = document.getElementById('reg-documento');
      const inpNombre = document.getElementById('reg-nombre');
      const inpContacto = document.getElementById('reg-contacto');
      const selResidencia = document.getElementById('reg-residencia');
      const inpServicio = document.getElementById('reg-servicio');
      const inpProfesional = document.getElementById('reg-profesional');
      const taSolicitud = document.getElementById('reg-solicitud');
      const taRespuesta = document.getElementById('reg-respuesta');
      const filtroResidencia = document.getElementById('reg-residencia-filter');

      inpDoc.value = '';
      inpNombre.value = '';
      inpContacto.value = '57';
      selResidencia.value = '';
      filtroResidencia.value = '';
      // Asegurar todas las opciones visibles
      Array.from(selResidencia.options).forEach((opt, idx) => { if (idx>0) opt.hidden = false; });

      inpServicio.value = servicioProfesional || '';
      inpProfesional.value = nombreProfesional || '';
      taSolicitud.value = '';
      taRespuesta.value = '';

      // Focus al primer campo
      setTimeout(()=>inpDoc.focus(), 200);

      modalRegistroInstance = new bootstrap.Modal(document.getElementById('modalRegistro'));
      const btnBuscar = document.getElementById('btnBuscarDocumento');
  if (btnBuscar){
    btnBuscar.onclick = function(){
      playSoundOnce(SOUNDS.back);
      buscarYAutocompletarRegistro();
    };
  }
      modalRegistroInstance.show();
    }

    // Filtro de Residencia
    (function(){
      const filtro = document.getElementById('reg-residencia-filter');
      const select = document.getElementById('reg-residencia');
      if (filtro && select){
        filtro.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          let firstVisibleValue = '';
          Array.from(select.options).forEach((opt, idx) => {
            if (idx === 0) return; // placeholder
            const text = (opt.textContent || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const visible = text.includes(q);
            opt.hidden = !visible;
            if (visible && !firstVisibleValue) firstVisibleValue = opt.value;
          });
        });
      }
    })();

    // Desactivar tooltips nativos SOLO dentro del formulario de registro
    (function(){
      const formReg = document.getElementById('formRegistro');
      if (formReg){
        formReg.addEventListener('invalid', function(e){ e.preventDefault(); }, true);
        formReg.setAttribute('novalidate', 'novalidate');
      }
    })();

    // Validaciones helper
    function soloDigitos(str){ return (str||'').replace(/\D/g,''); }
    function validarRegistroForm(){
      const doc = soloDigitos(document.getElementById('reg-documento').value);
      const nombre = (document.getElementById('reg-nombre').value||'').trim();
      let contacto = soloDigitos(document.getElementById('reg-contacto').value);
      const residencia = document.getElementById('reg-residencia').value || '';
      const servicio = (document.getElementById('reg-servicio').value||'').trim();
      const profesional = (document.getElementById('reg-profesional').value||'').trim();
      const solicitud = (document.getElementById('reg-solicitud').value||'').trim();
      const respuesta = (document.getElementById('reg-respuesta').value||'').trim();

      // Documento: 6-10 dígitos
      if (!/^\d{6,10}$/.test(doc)) {
        return { ok:false, msg:'El DOCUMENTO debe tener entre 6 y 10 dígitos.' };
      }

      // Nombre: mínimo 2 palabras
      const palabras = nombre.split(/\s+/).filter(Boolean);
      if (palabras.length < 2) {
        return { ok:false, msg:'El NOMBRE debe contener al menos 2 palabras.' };
      }

      // Contacto: 12 dígitos, inicia con 57
      if (!contacto.startsWith('57')) contacto = '57' + contacto;
      if (!/^\d{12}$/.test(contacto)) {
        return { ok:false, msg:'El CONTACTO debe tener 12 dígitos y comenzar con 57.' };
      }

      // Residencia requerida
      if (!residencia) {
        return { ok:false, msg:'Selecciona una RESIDENCIA.' };
      }

      // Servicio / Profesional auto y requeridos
      if (!servicio) {
        return { ok:false, msg:'El SERVICIO no está definido para tu sesión.' };
      }
      if (!profesional) {
        return { ok:false, msg:'El PROFESIONAL no está definido para tu sesión.' };
      }

      if (!solicitud) {
        return { ok:false, msg:'La SOLICITUD es requerida.' };
      }
      if (!respuesta) {
        return { ok:false, msg:'La RESPUESTA es requerida.' };
      }

      return {
        ok:true,
        data:{
          documento: doc,
          nombre: nombre,
          telefono: contacto,
          residencia: residencia,
          servicio: servicio,
          responsable: profesional,
          solicitud: solicitud,
          respuesta: respuesta
        }
      };
    }

    // Envío del registro
    document.getElementById('formRegistro').addEventListener('submit', async function(e){
      e.preventDefault();
      const val = validarRegistroForm();
      if (!val.ok){
        Swal.fire({ icon:'warning', title:'Validación', text: val.msg, customClass: { popup:'swal2-responsive-popup' } });
        return;
      }

      try{
        Swal.fire({ title:'Guardando...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
        const res = await apiGuardarSolicitud(val.data);
        Swal.close();

        if (!res || res.success !== true){
          throw new Error(res && res.message ? res.message : 'No se pudo guardar el registro');
        }

        // Recargar datos para refrescar tabla y __ROW__
        const reval = await apiValidarProfesional(documentoGuardado);
        if (reval && reval.existe === true){
          esAdmin = !!reval.esAdmin;
          nombreProfesional = reval.nombreProfesional || nombreProfesional;
          servicioProfesional = reval.servicioProfesional || servicioProfesional;
          encabezados = reval.encabezados || encabezados;
          filas = reval.filas || filas;

          if (tabla){ tabla.destroy(); }
          inicializarTabla();
        }

        if (modalRegistroInstance){
          modalRegistroInstance.hide();
        }

        playSoundOnce(SOUNDS.success);
        Swal.fire({
          icon:'success',
          title:'Registro guardado',
          html:'El servicio fue registrado correctamente.',
          timer:2200,
          showConfirmButton:false
        });
      }catch(err){
        Swal.fire({ icon:'error', title:'Error al guardar', text:String(err) });
      }
    });

    // Forzar formato de entradas numéricas en Registro
    (function(){
      const doc = document.getElementById('reg-documento');
      const tel = document.getElementById('reg-contacto');
      if (doc){
        doc.addEventListener('input', function(){
          this.value = soloDigitos(this.value).slice(0, 10);
        });
      }
      if (tel){
        tel.addEventListener('input', function(){
          let v = soloDigitos(this.value);
          if (!v.startsWith('57')) v = '57' + v;
          this.value = v.slice(0, 12);
        });
      }
    })();
  </script>
</body>
</html>
